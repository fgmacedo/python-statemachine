# StateMachine 3.05.0

*Not released yet*

## What's new in 3.0.0

Statecharts are there! Now the library has support for Compound and Parallel states.

### Python compatibility in 3.0.0

StateMachine 3.0.0 supports Python 3.9, 3.10, 3.11, 3.12, and 3.13.


### Create state machine class from a dict definition

Dinamically create state machine classes by using `create_machine_class_from_definition`.


``` py
>>> from statemachine.io import create_machine_class_from_definition

>>> machine = create_machine_class_from_definition(
...     "TrafficLightMachine",
...     **{
...         "states": {
...             "green": {"initial": True, "on": {"change": [{"target": "yellow"}]}},
...             "yellow": {"on": {"change": [{"target": "red"}]}},
...             "red": {"on": {"change": [{"target": "green"}]}},
...         },
...     }
... )

>>> sm = machine()
>>> sm.green.is_active
True
>>> sm.send("change")
>>> sm.yellow.is_active
True

```


### In(state) checks in condition expressions

Now a condition can check if the state machine current set of active states (a.k.a `configuration`) contains a state using the syntax  `cond="In('<state-id>')"`.

### Preparing events

You can use the `prepare_event` method to add custom information
that will be included in `**kwargs` to all other callbacks.

A not so usefull example:

```py
>>> class ExampleStateMachine(StateMachine):
...     initial = State(initial=True)
...
...     loop = initial.to.itself()
...
...     def prepare_event(self):
...         return {"foo": "bar"}
...
...     def on_loop(self, foo):
...         return f"On loop: {foo}"
...

>>> sm = ExampleStateMachine()

>>> sm.loop()
'On loop: bar'

```

### Event matching following SCXML spec

Now events matching follows the SCXML spec.

For example, a transition with an `event` attribute of `"error foo"` will match event names `error`, `error.send`, `error.send.failed`, etc. (or `foo`, `foo.bar` etc.)
but would not match events named `errors.my.custom`, `errorhandler.mistake`, `error.send` or `foobar`.

An event designator consisting solely of `*` can be used as a wildcard matching any sequence of tokens, and thus any event.


## Bugfixes in 3.0.0

- Fixes [#XXX](https://github.com/fgmacedo/python-statemachine/issues/XXX).

## Misc in 3.0.0

TODO.

## Backward incompatible changes in 3.0

- Dropped support for Python `3.7` and `3.8`. If you need support for these versios use the 2.* series.


## Non-RTC model removed

This option was deprecated on version 2.3.2. Now all new events are put on a queue before being processed.


## Multiple current states

Due to the support of compound and parallel states, it's now possible to have multiple active states at the same time.

This introduces an impedance mismatch into the old public API, specifically, `sm.current_state` is deprecated and `sm.current_state_value` can returns a flat value if no compound state or a `list` instead.

```{note}
To allow a smooth migration, these properties still work as before if there's no compound states in the state machine definition.
```

Old

```py
    def current_state(self) -> "State":
```

New

```py
    def current_state(self) -> "State | MutableSet[State]":
```

We recomend using the new `sm.configuration` that has a stable API returning an `OrderedSet` on all cases:

```py
    @property
    def configuration(self) -> OrderedSet["State"]:
```
